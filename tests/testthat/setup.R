#
# SELECT DATABASE and CO2 CONFIGURATION
#

# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "Eunomia-GiBleed")
# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "Eunomia-MIMIC")
# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "Eunomia-FinnGen")
# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "AtlasDevelopment-5k")
# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "AtlasDevelopment-full")
# Sys.setenv(HADESEXTAS_TESTING_ENVIRONMENT = "Synthea-S10")
testingDatabase <- Sys.getenv("HADESEXTAS_TESTING_ENVIRONMENT")

testingCO2AnalysisModulesConfig <- "AtlasDemo"

# check correct settings
possibleDatabases <- c("Eunomia-GiBleed", "Eunomia-MIMIC", "Eunomia-FinnGen", "AtlasDevelopment-5k", "AtlasDevelopment-full", "Synthea-S10")
if (!(testingDatabase %in% possibleDatabases)) {
  message("Please set a valid testing environment in envar HADESEXTAS_TESTING_ENVIRONMENT, from: ", paste(possibleDatabases, collapse = ", "))
  stop()
}

#
# Eunomia Databases
#
if (testingDatabase |> stringr::str_starts("Eunomia")) {
  if (Sys.getenv("EUNOMIA_DATA_FOLDER") == "") {
    message("EUNOMIA_DATA_FOLDER not set. Please set this environment variable to the path of the Eunomia data folder.")
    stop()
  }

  pathToGiBleedEunomiaSqlite <- Eunomia::getDatabaseFile("GiBleed", overwrite = FALSE)
  pathToMIMICEunomiaSqlite <- Eunomia::getDatabaseFile("MIMIC", overwrite = FALSE)

  test_databasesConfig <- HadesExtras::readAndParseYaml(
    pathToYalmFile = testthat::test_path("config", "databasesConfig.yml"),
    pathToGiBleedEunomiaSqlite = pathToGiBleedEunomiaSqlite,
    pathToMIMICEunomiaSqlite = pathToMIMICEunomiaSqlite,
    pathToFinnGenEunomiaSqlite = ""  #helper_FinnGen_getDatabaseFile()
  )

  if (testingDatabase |> stringr::str_ends("GiBleed")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$E1$cohortTableHandle
  }
  if (testingDatabase |> stringr::str_ends("MIMIC")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$E2$cohortTableHandle
  }
  if (testingDatabase |> stringr::str_ends("FinnGen")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$E4$cohortTableHandle
  }

  # add test cohorts and cohort definitions
  helper_addCohortAndCohortDefinitionTables(cohortTableHandlerConfig = test_cohortTableHandlerConfig)
}


#
# AtlasDevelopmet-DBI Database
#
if (testingDatabase |> stringr::str_starts("AtlasDevelopment")) {
  if (Sys.getenv("GCP_SERVICE_KEY") == "") {
    message("GCP_SERVICE_KEY not set. Please set this environment variable to the path of the GCP service key.")
    stop()
  }

  bigrquery::bq_auth(path = Sys.getenv("GCP_SERVICE_KEY"))

  test_databasesConfig <- HadesExtras::readAndParseYaml(
    pathToYalmFile = testthat::test_path("config", "databasesConfig.yml")
  )

  if (testingDatabase |> stringr::str_ends("5k")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$BQ5K$cohortTableHandler
  }
  if (testingDatabase |> stringr::str_ends("full")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$BQ5$cohortTableHandler
  }
}

#
# Synthea Database
#
if (testingDatabase |> stringr::str_detect("Synthea")) {
  test_databasesConfig <- HadesExtras::readAndParseYaml(
    pathToYalmFile = testthat::test_path("config", "databasesConfig.yml")
  )
  if (testingDatabase |> stringr::str_ends("S10")) {
    test_cohortTableHandlerConfig <- test_databasesConfig$S10$cohortTableHandler
  }
}

#
# CO2 Analysis Modules Configuration
#
if(testingCO2AnalysisModulesConfig == "AtlasDemo"){
  pathToCO2AnalysisModulesConfigYalm  <-  testthat::test_path("config", "CO2AnalysisModulesConfig.yml")
  test_CO2AnalysisModulesConfig <- HadesExtras::readAndParseYaml(pathToCO2AnalysisModulesConfigYalm)
}

#
# INFORM USER
#
message("************* Testing on: ")
message("Database: ", testingDatabase)
message("CO2 Analysis Modules Configuration: ", testingCO2AnalysisModulesConfig)



if (interactive()) {
  options(
    "hadesextras.cohortTableHandlerConfig" = test_cohortTableHandlerConfig
  )
} else {
  withr::local_options(
    "hadesextras.cohortTableHandlerConfig" = test_cohortTableHandlerConfig,
    .local_envir = teardown_env()
  )
}
